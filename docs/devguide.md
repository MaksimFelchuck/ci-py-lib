# Правила разработки библиотеки утилит на Python для использования в системах Continuous Integration

Каждая утилита - это отдельный файл .py. Он может быть использован двумя способами:

1) как команда ОС, при этом параметры передаются через командную строку, код возврата 0 - означает успешное выполнение, не 0 - ошибку. В процессе работы утилита должна выводить в stdout/stderr информацию о ходе выполнения и диагностику ошибок, достаточную для отладки программы, которая использует данную утилиту. Функция, которая используется для запуска утилиты в этом режиме должна называться use_as_os_command, внутри себя разбирать командную строку и выполнять нужные действия;

2) как подключаемый модуль python, имя функции для вызова совпадает с именем скрипта, но могут быть и другие функции, которые должны быть документированы внутри самого модуля (см. ниже). Основная функция должна возвращать 0 в случае успеха, не 0 при ошибке. Функции, находящиеся внутри утилиты, но не предназначенные для вызова извне, должны оставаться локальными. Диагностика ошибочных ситуаций должна быть достаточной, чтобы можно было диагностировать ошибки по коду возврата основной функции (и дополнительных функций если это необходимо)

Каждая утилита содержит внутри себя документацию для разработчика, который будет использовать библиотеку. Формат документирования определен ниже.

Исходный код утилит должен соответствовать http://google.github.io/styleguide/pyguide.html

В библиотеке есть пример утилиты: util_sample.py, который можно использовать как шаблон. Если вы обнаружили несоответствие шаблонной утилиты и данной документации, пожалуйста, сообщайте нам.

## Структура репозитария

/lib-utils - здесь находятся все файлы утилит и их "запчасти". Все, что есть в этом каталоге и есть библиотека утилит. Для ее использования достаточно просто скопировать этот каталог со всем содержимым.

/tests - здесь находятся скрипты тестов на каждую утилиту, и скрипты, которые запускают эти тесты и формируют отчет об их выполнении. Этот каталог служебный, он не является частью утилит самой библиотеки.

/docs - документация для разработчиков библиотеки утилит.

Другие каталоги и файлы служебные и не используются утилитами.


## Документирование утилит

Каждая утилита и все ее дополнительные .py файлы должны быть документированы следующим образом:

1. В начале файла записывается лицензия (это должна быть копия лицензии библиотеки).
2. Внутри текста лицензии в самом ее конце указывается автор утилиты по примеру утилиты util_sample.py.
3. Сразу за текстом лицензии следует описание утилиты в формате docstring (пример можно посмотреть в util_sample.py).
4. Все экспортируемые функции документируются в соответствие с CodeStyle (см. выше).
5. При запуске утилиты из командной строки с ключами -h или --help в stdout должна выводиться docstring функции use_as_os_command по использованию утилиты в качестве команды ОС.

Уточнение: скрипты тестов утилиты не являются ее частью, и под указанные выше требования не попадают.

## Правило обратной совместимости утилит должно выполнятся всегда

Единожды попав в библиотеку скрипт не имеет права менять свой интерфейс и поведение. 
Для достижения этого существуют такие правила:

- вместе со скриптом заливаются автотесты на него (см. дальше как они устроены и что они делают)
- после заливки этих автотестов они больше никогда не изменяются, а успешность их прохождения проверяется при сборке библиотеки

Таким образом, если какие-либо изменения в утилите повлекли ошибку в автотестах, то эти изменения отвергаются.

При добавлении каждой новой утилиты, вместе с ней добавляется каталог с тестами, который начинается с уникального для всей библиотеки номера:

 tests/NNNN_test_\<utilit yname\>

Где NNNN - тот самый уникальный номер. В каталоге располагаются скрипты тестов, которые именуются следующим образом:

 NNNN_test_N_\<utlity name\>.py
 
Где N - порядковый номер теста.
 
Скрипт теста при успехе должен завершаться с кодом возврата 0. В случае ошибки код возврата НЕ 0.
 
Для запуска всех тестов используется скрипт:

 tests/lib_full_test.py

Рабочим каталогом ля их выполнения является каталог tests.

При написании тестов обязательно использование следующих правил:
  
1. В каждом файле должен быть только один тест, если только обратное не продиктовано логикой самого теста
2. Задача теста - сформировать условия для запуска скрипта и выполнить его вот таким образом:
 
<pre>
import lib_test_runner
res = lib_test_runner.run(['../../-lib-utils/<script name>', 'arg1',.. ], "Message for tests report")
</pre>
 
3. Завершение скрипта следует делать c помощью следующих вызовов:
  - в случае успешного заверения теста:
<pre> 
     lib_test_runner.test_ok()
</pre> 
- в случае ошибки:
<pre>
     lib_test_runner.test_fail()
</pre> 

## Локальная конфигурация

Для работы библиотеки в конкретной инсталляции могут потребоваться локальные настройки. Все эти настройки должны находится в файле 

 lib_config.py
 
который находится вне репозитария. В качестве шаблона для этого файла в репозитарии находится файл

 lib-utils/lib_config.py.sample

Для запуска тестов файл lib_config.py создается в каталоге tests.
 
## Правила работы с репозитарием библиотеки
 
Для разработки каждой новой утилиты заводится ветка с именем:
 
 NNNN_\<utility name\>,
 
 где NNNN уникальный номер внутри всей библиотеки.
  
Вместе с самой утилитой разрабатываются скрипты тестов для нее. Как формируется имя каталога скриптов и их имена описано выше.

Для приемки утилиты нужно влить в ее ветку самый последний мастер, проверить, что выполняются все тесты всей библиотеки включая и новую утитлиту, привести исходный код в соответствие с требованиями указанными выше, после этого запросить мерж-реквест.

Утилита принимается в библиотеку если она удовлетворяет всем требованиям данного документа, работает так, как описано в ее документации, и нужна для самой библиотеки.
 
## Правила использования сторонних библиотек

Сторонние библиотеки можно использовать. Лицензия на сторонние библиотеки должна разрешать их бесплатное использование в любых вариантах, включая коммерческое. Все пункты лицензии сторонней библиотеки должны быть соблюдены. Все сторонние библиотеки должны быть перечислены в файле:

 lib-utils/requirements.txt
 
Формат файла должен удовлетворять этим требованиям:
 
 https://pip.pypa.io/en/stable/reference/pip_install/#requirements-file-format

